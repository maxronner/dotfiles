#!/usr/bin/env bash
set -euo pipefail

file="$HOME/.local/share/emoji.txt"
query=""

# Parse options
while [[ $# -gt 0 ]]; do
  case "$1" in
    -f|--file)
      file="$2"
      shift 2
      ;;
    --)
      shift
      break
      ;;
    -*)
      echo "Unknown option: $1" >&2
      exit 1
      ;;
    *)
      break
      ;;
  esac
done

# Remaining arguments form the query
query="$*"

# Run fzf in a subshell, capture output and exit code explicitly
fzf_output=""
fzf_exit=0
if ! fzf_output=$(<"$file" fzf --tmux --query="$query" --multi --select-1 --exit-0); then
  fzf_exit=$?
fi

# Handle Ctrl+C or other non-zero exits
if [[ $fzf_exit -eq 130 ]]; then
  exit 130
elif [[ $fzf_exit -ne 0 ]]; then
  exit "$fzf_exit"
fi

# Process and emit selected emoji
selected_emoji=$(printf '%s\n' "$fzf_output" | awk '{print $1}' | paste -sd '' -)
[[ -n "$selected_emoji" ]] && echo "$selected_emoji"

