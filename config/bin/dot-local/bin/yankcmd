#!/usr/bin/env bash
set -euo pipefail

mode="clipboard"

while [[ $# -gt 0 ]]; do
  case "$1" in
    -m|--mode)
      mode=${2:?missing argument for $1}
      shift 2
      ;;
    --)
      shift
      break
      ;;
    -*)
      echo "Unknown option: $1" >&2
      exit 1
      ;;
    *)
      break
      ;;
  esac
done

if [[ $# -eq 0 ]]; then
  echo "Usage: $0 [-m|--mode insert|clipboard] <command> [args...]" >&2
  exit 1
fi

if [[ "$mode" != "clipboard" && -z ${TMUX-} ]]; then
  echo "tmux is required for insert mode" >&2
  exit 1
fi

copy_clipboard() {
  if command -v wl-copy &>/dev/null; then
    exec wl-copy
  elif command -v xclip &>/dev/null; then
    exec xclip -selection clipboard
  elif command -v xsel &>/dev/null; then
    exec xsel --clipboard --input
  else
    echo "No clipboard utility found" >&2
    return 1
  fi
}

set +e
result="$("$@")"
status=$?
set -e

# Treat Ctrl+C / Esc as clean abort
if [[ $status -eq 130 || $status -eq 1 || -z $result ]]; then
  exit 0
fi

if [[ -n "$result" && "$mode" == "clipboard" ]]; then
  printf '%s' "$result" | copy_clipboard
elif [[ -n "$result" ]]; then
  caller_pane=$(tmux display-message -p '#{pane_id}')
  tmux send-keys -t "$caller_pane" -- "$result"
fi

