#!/usr/bin/env bash
set -euo pipefail

#–– Default values
MARKER="scratch"
COMMAND=()
POPUP=0
KILL=0
SMALL=0
VERTICAL=0

print_help() {
  cat <<-EOF
Create quick and dirty scratch panes in tmux

Usage: $(basename "$0") [-m MARKER] [-v] [-s] [--] [COMMAND...]

Options:
  -m, --marker MARKER    Name of the pane to find/create (default: $MARKER)
  -v, --vertical         Use a vertical split (top/bottom). Default is horizontal.
  -s, --small            Use smaller than half-size pane splits
  -k, --kill             Kill the pane after running the command
  -P, --popup            Use a popup window instead of a split pane
  -h, --help             Show this help message and exit

Everything after the '--' is treated as the COMMAND to run in your pane;
e.g.:

  $(basename "$0") -m ai -v -- tgpt --chat --model gpt-4
EOF
}

#–– Use GNU getopt to support long options and `--`
OPTS=$(getopt \
  --options m:vshkP \
  --longoptions marker:,vertical,small,help,kill,popup \
  --name "$(basename "$0")" \
  -- "$@"
) || exit 1

eval set -- "$OPTS"

#–– Parse flags
while true; do
  case "$1" in
    -m|--marker)
      MARKER="__$2__"
      shift 2
      ;;
    -s|--small)
      SMALL=1
      shift
      ;;
    -v|--vertical)
      VERTICAL=1
      shift
      ;;
    -k|--kill)
      KILL=1
      shift
        ;;
    -P|--popup)
      POPUP=1
      shift
      ;;
    -h|--help)
      print_help
      exit 0
      ;;
    --)
      shift
      break
      ;;
    *)
      # Should never happen
      echo "Unexpected option: $1" >&2
      exit 1
      ;;
  esac
done

#–– Anything left is the command to run
if [[ $# -gt 0 ]]; then
  COMMAND=("$@")
  if [ "$KILL" -eq 0 ]; then
    COMMAND+=("; read")
  fi
fi

#–– Normalize POS into the tmux args you want
POS_ARGS=(-h)
if [ "$VERTICAL" -eq 1 ]; then
  POS_ARGS=(-v)
fi

if [ "$SMALL" -eq 1 ]; then
  if [ "$VERTICAL" -eq 1 ]; then
    POS_ARGS=(-fv -l 12)
  else
    POS_ARGS=(-fh -l 80)
  fi
fi

exec &>/dev/null # Hide output

if [ "$POPUP" -eq 1 ]; then
  COMMAND_STRING="${COMMAND[*]}"
  if (( ${#COMMAND[@]} )); then
    tmux display-popup -w 80% -h 80% -E "${COMMAND_STRING:+ "$COMMAND_STRING"}"|| true
  else
    shell=$(getent passwd "$USER" | cut -d: -f7)
    tmux display-popup -w 80% -h 80% -E "$shell" || true
  fi
  exit 0
fi

SESSION=$(tmux display -p '#S')
SRC_IDX=$(tmux display -p '#I')
PANE_INFO=$(tmux list-panes -a -F "#{session_name}:#{window_index}.#{pane_index} #{pane_title}" \
  | awk -v s="$SESSION" -v m="$MARKER" '$0 ~ s && $0 ~ m {print; exit}')
LAST_PANE_INDEX=$(tmux list-panes -t "$SESSION:$SRC_IDX" -F '#{pane_index}' | tail -n1)

if [[ -n $PANE_INFO ]]; then
  PANE_ID=${PANE_INFO%% *}
  PANE_WIN=${PANE_ID#*:}
  WIN_IDX=${PANE_WIN%%.*}

  if (( WIN_IDX == SRC_IDX )); then
    (( LAST_PANE_INDEX == 1 )) && exit

    tmux break-pane -d -s "$PANE_ID" -n "$MARKER"

    LAST_INDEX=$(tmux list-windows -F '#{window_index}' | tail -n1)
    tmux select-window -t :"$LAST_INDEX"
    tmux select-window -t "$SESSION:$SRC_IDX"
  else
    tmux move-pane -s "$PANE_ID" -t "$SESSION:$SRC_IDX.$LAST_PANE_INDEX" "${POS_ARGS[@]}"
    tmux select-window -t "$SESSION:$SRC_IDX"
  fi
else
  CURRENT_DIR=$(tmux display -p -F '#{pane_current_path}')

  NEW_PANE=$(tmux split-window -P -F '#{pane_id}' \
    -t "$SESSION:$SRC_IDX.$LAST_PANE_INDEX" \
    -c "$CURRENT_DIR" \
    "${POS_ARGS[@]}" \
    ${COMMAND:+ "${COMMAND[*]}"} )

  tmux select-pane -t "$NEW_PANE" -T "$MARKER"
fi
