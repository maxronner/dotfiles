#!/usr/bin/env bash
set -euo pipefail
exec &>/dev/null # Hide output

#–– Configuration & discovery
SESSION="$(tmux display-message -p '#S')"             # current session name
MARKER="__scratch__"                                    # marker pane name
SRC_IDX="$(tmux display-message -p '#I')"             # your "current" window index

#–– Try to locate any pane titled $MARKER, anywhere in this session
#    Output format: "session:window.pane  TITLE"
PANE_INFO=$(
  tmux list-panes -a -F "#{session_name}:#{window_index}.#{pane_index} #{pane_title}" \
  | grep -F "$SESSION" \
  | grep -F "$MARKER" || true
)

LAST_PANE_INDEX=$(tmux list-panes -t "$SESSION:$SRC_IDX" | wc -l)

if [[ -n "$PANE_INFO" ]]; then
  echo "Found helper pane: $PANE_INFO"
  # –– We found our helper pane… let’s parse out its ID and owning window
  PANE_ID="${PANE_INFO%% *}"                          # e.g. "mysession:3.2"
  PANE_WIN="${PANE_ID#*:}"                            # drop session prefix → "3.2"
  WIN_IDX="${PANE_WIN%%.*}"                           # take "3" out of "3.2"

  if (( WIN_IDX == SRC_IDX )); then
    if (( LAST_PANE_INDEX == 1 )); then
      exit
    fi
    echo "It’s in the source window → moving it to target"
    tmux break-pane -d -s "$PANE_ID"                   # pop it out into its own window

    # -- Select the target window for easy access with last-window
    LAST_INDEX=$(tmux list-windows -F "#{window_index}" | sort -n | tail -1)
    tmux select-window -t :"$LAST_INDEX"
    tmux select-window -t "$SESSION:$SRC_IDX"
  else
    echo "It’s somewhere else → moving it back to source"
    # Move the pane to the last position
    tmux move-pane -s "$PANE_ID" -ft "$SESSION:$SRC_IDX.$LAST_PANE_INDEX" -l 10
    echo "Selecting window"
    tmux select-window -t "$SESSION:$SRC_IDX"
  fi

else
  echo "No helper pane found"
  if [ $# -ne 0 ]; then
    echo "Creating new pane with command: $@"
    NEW_PANE=$(tmux split-window -P -F '#{pane_id}' -ft "$SESSION:$SRC_IDX.$LAST_PANE_INDEX" -l 10 "$@")
  else
    echo "Creating new pane"
    NEW_PANE=$(tmux split-window -P -F '#{pane_id}' -ft "$SESSION:$SRC_IDX.$LAST_PANE_INDEX" -l 10)
  fi
  tmux select-pane -t "$NEW_PANE"
  tmux select-pane -T "$MARKER"
fi

